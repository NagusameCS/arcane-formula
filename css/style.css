*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0806;--panel:#131008;--border:#2a2015;--gold:#ffd700;--gold-dim:#aa8800;
  --text:#d4c5a0;--dim:#665533;--blue:#4488ff;--red:#ff4455;--green:#44cc66;
  --surface:#1a1510;--surface2:#0e0b06;
}
body{background:var(--bg);color:var(--text);font-family:'Courier New',monospace;overflow:hidden}
canvas{display:block;width:100vw;height:100vh;image-rendering:pixelated;image-rendering:crisp-edges}
.hidden{display:none!important}
.overlay{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.95)}

/* ── SCROLLBAR ── */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--gold-dim)}

/* ── BUTTONS ── */
.btn-gold{
  background:linear-gradient(180deg,#2a2010,#14100a);border:1px solid var(--gold);color:var(--gold);
  font-family:inherit;font-size:14px;padding:10px 28px;cursor:pointer;letter-spacing:3px;
  transition:all .15s;text-transform:uppercase;
}
.btn-gold:hover{background:#2a2010;box-shadow:0 0 20px rgba(255,215,0,.2)}

/* ── LOBBY ── */
.lobby-box{text-align:center;max-width:420px;width:100%}
.lobby-title{font-size:32px;color:var(--gold);letter-spacing:10px;text-shadow:0 0 30px rgba(255,215,0,.3);margin-bottom:6px}
.lobby-sub{color:var(--dim);font-size:13px;margin-bottom:35px}
.lobby-actions{display:flex;flex-direction:column;gap:12px;align-items:center}
.lobby-divider{color:#444;font-size:12px;margin:4px 0}
.join-row{display:flex;gap:8px}
.join-row input{
  background:var(--panel);border:1px solid var(--border);color:var(--gold);font-family:inherit;
  font-size:16px;padding:10px 14px;width:150px;text-align:center;letter-spacing:4px;outline:none;
  text-transform:uppercase;
}
.join-row input:focus{border-color:var(--gold)}
.room-status{margin-top:18px;font-size:12px;color:var(--dim);min-height:18px}
.room-code{
  margin-top:12px;font-size:28px;color:var(--gold);letter-spacing:8px;
  text-shadow:0 0 20px rgba(255,215,0,.4);padding:12px 24px;border:1px dashed var(--gold-dim);
  display:inline-block;
}

/* ═══════════════════════════════════════════════
   SPELLBOOK — Full Redesign
   ═══════════════════════════════════════════════ */
.spellbook-wrap{
  width:100%;max-width:960px;height:100vh;
  display:flex;flex-direction:column;padding:16px 24px;
}

/* ── TOP BAR: Spell tabs + Ready ── */
.spellbook-topbar{
  display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-shrink:0;
}
.spell-tabs{display:flex;gap:4px;flex:1}
.spell-tab{
  display:flex;align-items:center;gap:6px;
  padding:8px 14px;background:var(--surface);border:1px solid var(--border);
  cursor:pointer;transition:all .15s;font-family:inherit;font-size:12px;color:var(--dim);
  letter-spacing:1px;
}
.spell-tab:hover{border-color:var(--gold-dim);color:var(--text)}
.spell-tab.active{
  border-color:var(--gold);color:var(--gold);background:var(--panel);
  box-shadow:0 0 10px rgba(255,215,0,.1);
}
.spell-tab .tab-num{
  width:20px;height:20px;border:1px solid currentColor;
  display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;flex-shrink:0;
}
.spell-tab .tab-name{
  max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}

/* ── MAIN AREA: split into editor + palette ── */
.spellbook-main{
  flex:1;display:flex;gap:12px;min-height:0;overflow:hidden;
}

/* Left: the spell editor card */
.spell-editor-panel{
  flex:1;display:flex;flex-direction:column;gap:0;
  background:var(--panel);border:1px solid var(--border);overflow:hidden;
}

/* Spell header inside card */
.spell-header{
  display:flex;align-items:center;gap:12px;padding:12px 16px;
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.spell-header .card-key{
  width:32px;height:32px;border:1px solid var(--gold);color:var(--gold);
  display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;flex-shrink:0;
}
.spell-header .card-name{
  flex:1;background:transparent;border:none;border-bottom:1px solid var(--border);
  color:var(--text);font-family:inherit;font-size:18px;padding:4px 0;outline:none;
}
.spell-header .card-name:focus{border-color:var(--gold)}
.spell-header .card-cost{display:flex;align-items:center;gap:6px;color:var(--dim);font-size:12px}
.spell-header .card-cost input{
  width:50px;background:var(--bg);border:1px solid var(--border);color:var(--gold);
  font-family:inherit;font-size:14px;text-align:center;padding:4px;outline:none;
}
.spell-header .card-cost input:focus{border-color:var(--gold)}

/* Formula tabs (x, y, emit, width) */
.formula-tabs{
  display:flex;border-bottom:1px solid var(--border);flex-shrink:0;
}
.formula-tab{
  flex:1;padding:8px 12px;text-align:center;font-family:inherit;
  font-size:11px;letter-spacing:2px;text-transform:uppercase;
  color:var(--dim);background:none;border:none;border-bottom:2px solid transparent;
  cursor:pointer;transition:all .15s;
}
.formula-tab:hover{color:var(--text);background:rgba(255,215,0,.03)}
.formula-tab.active{color:var(--gold);border-bottom-color:var(--gold);background:rgba(255,215,0,.05)}

/* LaTeX preview */
.latex-preview{
  padding:16px;background:var(--surface2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;min-height:60px;
  overflow-x:auto;flex-shrink:0;
}
.latex-preview .katex{font-size:1.2em}

/* Block workspace */
.block-workspace{
  flex:1;padding:12px;background:var(--bg);overflow:auto;
  display:flex;align-items:flex-start;flex-wrap:wrap;gap:4px;
  min-height:80px;cursor:pointer;position:relative;
}
.block-workspace.drop-target{border-color:var(--gold);box-shadow:inset 0 0 8px rgba(255,215,0,.1)}
.block-workspace-empty{
  width:100%;display:flex;align-items:center;justify-content:center;
  color:var(--dim);font-size:13px;min-height:60px;
  border:1px dashed #333;padding:12px;
}

/* Workspace toolbar */
.workspace-toolbar{
  display:flex;gap:6px;padding:6px 12px;border-top:1px solid var(--border);flex-shrink:0;
  background:var(--surface);
}
.ws-btn{
  background:none;border:1px solid var(--border);color:var(--dim);
  font-family:inherit;font-size:10px;padding:4px 10px;cursor:pointer;
  letter-spacing:1px;transition:all .15s;
}
.ws-btn:hover{border-color:var(--gold-dim);color:var(--text)}
.ws-btn.danger:hover{border-color:var(--red);color:var(--red)}

/* Right: Palette panel */
.palette-panel{
  width:220px;display:flex;flex-direction:column;
  background:var(--panel);border:1px solid var(--border);overflow:hidden;flex-shrink:0;
}
.palette-title{
  font-size:10px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;
  padding:10px 12px 6px;border-bottom:1px solid var(--border);flex-shrink:0;
}
.palette-scroll{
  flex:1;overflow-y:auto;padding:8px;
}
.palette-category{margin-bottom:10px}
.palette-cat-label{
  font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;
  margin-bottom:4px;padding-left:2px;
}
.palette-cat-items{display:flex;flex-wrap:wrap;gap:4px}

/* Individual blocks */
.block{
  display:inline-flex;align-items:center;padding:4px 8px;font-size:12px;cursor:grab;
  user-select:none;white-space:nowrap;border-radius:3px;gap:3px;
  transition:all .12s;position:relative;
}
.block:hover{box-shadow:0 0 8px rgba(255,255,255,.12);transform:translateY(-1px)}
.block.dragging{opacity:.5;cursor:grabbing}
.block-num{background:#1e3450;color:#88bbff;border:1px solid #2a4a6a}
.block-var{background:#1e3320;color:#88cc77;border:1px solid #2a4a33}
.block-op{background:#3d2818;color:#ffaa66;border:1px solid #5a3a20}
.block-func{background:#2e1a3d;color:#bb88ff;border:1px solid #4a2a5a}
/* Palette blocks are slightly different */
.palette-cat-items .block{
  padding:5px 10px;font-size:11px;cursor:pointer;
}
.palette-cat-items .block:hover{
  box-shadow:0 0 12px rgba(255,215,0,.15);border-color:var(--gold-dim);
}
.palette-cat-items .block:active{transform:scale(.95)}

.block-slot{
  display:inline-flex;min-width:28px;min-height:24px;border:1px dashed #444;
  background:#060503;align-items:center;justify-content:center;padding:0 6px;cursor:pointer;
  border-radius:2px;transition:all .15s;
}
.block-slot:hover{border-color:#666;background:#0d0a06}
.block-slot.active{border-color:var(--gold);background:#1a1508;box-shadow:0 0 8px rgba(255,215,0,.1)}
.block-slot .block{margin:0}
.block-remove{
  position:absolute;top:-6px;right:-6px;width:16px;height:16px;background:#3a1515;color:#f88;
  border:1px solid #633;font-size:9px;display:none;align-items:center;justify-content:center;
  cursor:pointer;z-index:5;line-height:1;border-radius:50%;
}
.block:hover > .block-remove{display:flex}
.block-remove:hover{background:#611;color:#fff}

/* ── SPELLBOOK BOTTOM ── */
.spellbook-bottom{
  display:flex;align-items:center;justify-content:space-between;
  padding-top:12px;flex-shrink:0;
}
.ready-status{font-size:12px;color:var(--dim)}
.btn-ready{font-size:16px;padding:12px 40px}

/* ── HUD ── */
#hud{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:10px 16px;z-index:50;pointer-events:none}
.hud-left,.hud-right{width:260px}
.hud-center{flex:1;display:flex;justify-content:center;padding-top:4px}
.hud-right{text-align:right}
.hud-label{font-size:10px;letter-spacing:3px;color:#665;margin-bottom:3px}
.hp-bar,.mana-bar{height:14px;background:#1a1510;border:1px solid var(--border);margin-bottom:3px;position:relative;overflow:hidden}
.hp-fill{height:100%;background:linear-gradient(90deg,#992222,#cc3333);width:100%;transition:width .2s}
.hp-enemy{background:linear-gradient(90deg,#cc3333,#992222)}
.mana-fill{height:100%;background:linear-gradient(90deg,#224488,#4488ff);width:100%;transition:width .1s;position:absolute;top:0;left:0}
.mana-locked{height:100%;background:#1a1a44;width:0;position:absolute;top:0;right:0;transition:width .1s}
.bar-text{position:absolute;right:6px;top:0;line-height:14px;font-size:9px;color:rgba(255,255,255,.5);z-index:2}
.spell-keys{display:flex;gap:3px;margin-top:5px}
.spell-key-hud{
  width:38px;height:24px;background:rgba(20,16,10,.8);border:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:8px;color:#665;pointer-events:auto;
}
.spell-key-hud .key-num{font-size:10px;color:var(--gold);font-weight:bold}
.spell-key-hud.on-cd{opacity:.4;border-color:#553}
.spell-key-hud.no-mana{opacity:.3;border-color:#533}
.dash-cd{font-size:10px;color:var(--dim);letter-spacing:2px}
.dash-cd.ready{color:var(--gold)}

/* ── PARTY PANEL ── */
.party-header{text-align:center;margin-bottom:18px}
.party-code-label{font-size:10px;letter-spacing:3px;color:var(--dim);margin-bottom:4px}
.party-code-value{
  font-size:28px;color:var(--gold);letter-spacing:8px;
  text-shadow:0 0 20px rgba(255,215,0,.4);padding:10px 20px;
  border:1px dashed var(--gold-dim);display:inline-block;
}
.party-members{
  margin:18px 0;display:flex;flex-direction:column;gap:6px;
  max-height:180px;overflow-y:auto;
}
.party-member{
  display:flex;align-items:center;gap:10px;padding:8px 14px;
  background:var(--surface);border:1px solid var(--border);
}
.pm-color{width:10px;height:10px;border-radius:50%;border:1px solid #444;flex-shrink:0}
.pm-nick{flex:1;font-size:13px;color:var(--text);letter-spacing:1px}
.pm-ready{font-size:10px;letter-spacing:2px}

/* ── PARTY MODE PICKER ── */
.party-mode-picker{margin:20px 0;text-align:center}
.party-mode-picker h3{font-size:12px;letter-spacing:4px;color:var(--gold);margin-bottom:12px}
.party-mode-grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:460px;margin:0 auto;
}
.party-mode-btn{
  background:var(--surface);border:1px solid var(--border);padding:14px 10px;
  cursor:pointer;text-align:center;font-family:inherit;transition:all .15s;
}
.party-mode-btn:hover{border-color:var(--gold-dim);background:#1a1510;transform:translateY(-1px)}
.party-mode-btn.selected{
  border-color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,.15);
  background:rgba(255,215,0,.05);
}
.party-mode-btn .pm-icon{font-size:18px;margin-bottom:4px}
.party-mode-btn .pm-label{font-size:10px;color:var(--gold);letter-spacing:2px}
.party-mode-btn .pm-desc{font-size:8px;color:var(--dim);margin-top:2px}

/* ── VICTORY ── */
#victory-screen{flex-direction:column;gap:14px}
#victory-screen h1{font-size:42px;color:var(--gold);letter-spacing:8px;text-shadow:0 0 40px rgba(255,215,0,.5)}
#victory-screen p{color:var(--dim);font-size:14px}
.victory-buttons{display:flex;gap:12px;justify-content:center;margin-top:8px}
#pvp-scoreboard{
  font-size:11px;letter-spacing:1px;line-height:1.5;
}
#pvp-mode-label{
  font-size:10px;letter-spacing:4px;color:var(--gold-dim);opacity:0.6;
}

/* ── MODE SELECT ── */
.mode-box{text-align:center;max-width:520px;width:100%}
.mode-buttons{display:flex;gap:20px;justify-content:center;margin-top:10px}
.mode-btn{
  background:linear-gradient(180deg,#1a1510,#0a0806);
  border:1px solid var(--border);color:var(--text);
  font-family:inherit;padding:24px 32px;cursor:pointer;
  transition:all .2s;width:200px;text-align:center;
}
.mode-btn:hover{border-color:var(--gold);box-shadow:0 0 20px rgba(255,215,0,.15);transform:translateY(-2px)}
.mode-icon{font-size:36px;margin-bottom:8px}
.mode-icon-text{
  font-size:22px;font-weight:bold;color:var(--gold);letter-spacing:4px;
  margin-bottom:8px;font-family:inherit;
}
.mode-label{font-size:16px;color:var(--gold);letter-spacing:3px;margin-bottom:6px}
.mode-desc{font-size:11px;color:var(--dim)}

/* ── CAMPAIGN HUD ── */
#campaign-hud{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:10px 16px;z-index:50;pointer-events:none}
.enemy-count{font-size:10px;letter-spacing:2px;margin-top:4px}

/* ── SPELL LIBRARY PANEL ── */
.spell-library-panel{
  flex:1;display:flex;flex-direction:column;
  background:var(--panel);border:1px solid var(--border);overflow-y:auto;
}
.library-header{padding:12px 16px;border-bottom:1px solid var(--border)}
.library-header h3{color:var(--gold);font-size:14px;letter-spacing:3px;margin-bottom:4px}
.library-header p{color:var(--dim);font-size:11px}
.library-category{padding:8px 12px}
.library-cat-label{
  font-size:10px;letter-spacing:3px;color:var(--gold-dim);
  margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);
}
.library-grid{display:flex;flex-wrap:wrap;gap:6px}
.library-card{
  width:calc(50% - 3px);background:var(--bg);border:1px solid var(--border);
  padding:8px 10px;cursor:pointer;transition:all .15s;
}
.library-card:hover{border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.1);transform:translateY(-1px)}
.library-card-name{font-size:12px;color:var(--text);font-weight:bold;margin-bottom:2px}
.library-card-cost{font-size:10px;color:var(--gold-dim);margin-bottom:3px}
.library-card-preview{font-size:10px;margin-bottom:3px;overflow:hidden;max-height:22px}
.library-card-preview .katex{font-size:0.7em}
.library-card-desc{font-size:9px;color:var(--dim);line-height:1.3}
.library-tab{background:var(--bg)!important;border-color:var(--gold-dim)!important;color:var(--gold-dim)!important}
.library-tab:hover{color:var(--gold)!important;border-color:var(--gold)!important}

/* ── Variable reference tooltip ── */
.var-ref{
  position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
  background:#1a1510;border:1px solid var(--border);padding:6px 10px;
  font-size:10px;color:var(--dim);white-space:nowrap;pointer-events:none;
  z-index:10;display:none;
}
.block-var:hover .var-ref{display:block}

/* ── MINIMAP ── */
#minimapCanvas{
  width:150px;height:100px;border:1px solid var(--border);
  background:#0a0806;image-rendering:pixelated;pointer-events:none;
}

/* ── SPELL DOCK (drag-drop targets in library) ── */
#spellDock{
  display:flex;flex-wrap:wrap;gap:4px;padding:8px 12px;border-bottom:1px solid var(--border);
  background:var(--surface);
}
.dock-slot{
  flex:1;min-width:80px;padding:8px;background:var(--bg);
  border:2px dashed var(--border);text-align:center;
  transition:all .15s;cursor:default;
}
.dock-slot .dock-num{
  display:block;font-size:11px;color:var(--gold);font-weight:bold;margin-bottom:2px;
}
.dock-slot .dock-name{
  display:block;font-size:9px;color:var(--dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.dock-slot.drag-over{
  border-color:var(--gold);background:rgba(255,215,0,.08);
  box-shadow:0 0 12px rgba(255,215,0,.2);
}

/* ── DRAG-DROP LIBRARY CARDS ── */
.library-card{cursor:grab}
.library-card:active{cursor:grabbing}
.library-card.dragging{opacity:.5;transform:scale(.95)}

/* ── FIX: Library card description should never be red ── */
.library-card-desc{color:var(--dim)!important}
.library-card-preview{color:var(--text)}

/* ── LEVEL UP OVERLAY ── */
.levelup-box{
  text-align:center;background:var(--panel);border:1px solid var(--gold);
  padding:30px 40px;max-width:400px;width:100%;
  box-shadow:0 0 60px rgba(255,215,0,.2);
}
.levelup-title{
  font-size:28px;color:var(--gold);letter-spacing:8px;
  text-shadow:0 0 30px rgba(255,215,0,.5);margin-bottom:4px;
}
.levelup-level{font-size:16px;color:var(--text);letter-spacing:3px;margin-bottom:16px}
.levelup-sub{font-size:12px;color:var(--dim);margin-bottom:20px}
.levelup-skills{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
.levelup-skill-btn{
  background:var(--bg);border:1px solid var(--border);padding:10px 14px;
  cursor:pointer;text-align:left;font-family:inherit;transition:all .15s;
  display:flex;align-items:center;gap:12px;
}
.levelup-skill-btn:hover:not(:disabled){
  border-color:var(--gold);background:#1a1510;
  box-shadow:0 0 15px rgba(255,215,0,.1);
}
.levelup-skill-btn:disabled{cursor:default}
.skill-name{font-size:12px;font-weight:bold;letter-spacing:2px;min-width:80px}
.skill-pips{font-size:14px;color:var(--gold);letter-spacing:2px;min-width:50px}
.skill-desc{font-size:10px;color:var(--dim);flex:1}
.levelup-done{margin-top:8px}
